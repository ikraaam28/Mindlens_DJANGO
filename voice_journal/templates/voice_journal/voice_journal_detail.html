<!DOCTYPE html>
<html lang="fr">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tails de l'enregistrement - MindLense</title>
    <link rel="stylesheet" href="{% static 'css/home.css' %}" />
    <style>
        .voice-hero {
            padding: 40px 0;
            background: linear-gradient(180deg, #ffffff, #f7fbff 55%, #f6fffb);
        }
        
        .voice-hero-content {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .voice-hero h1 {
            font-size: 36px;
            line-height: 1.2;
            margin: 0 0 12px;
            color: #101828;
        }
        
        .voice-detail-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius-lg);
            padding: 32px;
            margin: 32px 0;
            box-shadow: var(--shadow-sm);
        }
        
        .voice-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .voice-detail-date {
            color: #667085;
            font-size: 16px;
            font-weight: 600;
        }
        
        .voice-detail-actions {
            display: flex;
            gap: 12px;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .action-btn.favorite {
            background: #fef3c7;
            color: #92400e;
        }
        
        .action-btn.favorite:hover {
            background: #fde68a;
        }
        
        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-btn.delete:hover {
            background: #fecaca;
        }
        
        .action-btn.back {
            background: #f3f4f6;
            color: #374151;
        }
        
        .action-btn.back:hover {
            background: #e5e7eb;
        }
        
        .voice-detail-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f9fafb;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-secondary);
        }
        
        .voice-detail-section h3 {
            margin: 0 0 12px 0;
            color: #101828;
            font-size: 18px;
            font-weight: 700;
        }
        
        .voice-detail-content {
            color: #475467;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .analysis-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            margin: 4px 8px 4px 0;
        }
        
        .sentiment-positive {
            background: #dcfce7;
            color: #166534;
        }
        
        .sentiment-negative {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .sentiment-neutral {
            background: #f3f4f6;
            color: #374151;
        }
        
        .emotion-badge {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .audio-player {
            width: 100%;
            margin: 16px 0;
            border-radius: var(--radius-md);
        }
        
        .score-detail {
            font-size: 14px;
            color: #667085;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    {% include 'partials/nav.html' %}

    <main>
        <section class="voice-hero">
            <div class="container voice-hero-content">
                <div class="voice-icon">üé§</div>
                <h1>D√©tails de l'enregistrement</h1>
                <p>Analyse compl√®te de votre enregistrement vocal</p>
            </div>
        </section>

        <section class="container">
            <div class="voice-detail-card">
                <div class="voice-detail-header">
                    <div class="voice-detail-date" style="flex:1">
                        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                            <span style="color:#0f172a;font-weight:700;font-size:18px" id="titleDisplay">
                                {{ voice_entry.title|default_if_none:''|default:"Sans titre" }}
                            </span>
                            <button class="action-btn back" id="editTitleBtn">Modifier le titre</button>
                        </div>
                        <div id="titleEditor" style="display:none;margin-top:10px">
                            <input type="text" id="titleInput" value="{{ voice_entry.title|default_if_none:'' }}" placeholder="Ajouter un titre" 
                                   style="padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;min-width:260px;max-width:480px" />
                            <button class="action-btn back" id="saveTitleBtn">Enregistrer</button>
                            <button class="action-btn delete" id="cancelTitleBtn" type="button">Annuler</button>
                        </div>
                        <div style="margin-top:6px;color:#64748b;font-size:14px">
                            {{ voice_entry.created_at|date:"d F Y √† H:i" }}
                        </div>
                    </div>
                    <div class="voice-detail-actions">
                        <a href="{% url 'voice_journal_list' %}" class="action-btn back">‚Üê Retour √† la liste</a>
                        <a href="{% url 'voice_journal_toggle_favorite' voice_entry.pk %}" class="action-btn favorite">
                            {% if voice_entry.is_favorite %}‚≠ê Retir√© des favoris{% else %}‚≠ê Ajouter aux favoris{% endif %}
                        </a>
                        <a href="{% url 'voice_journal_delete' voice_entry.pk %}" class="action-btn delete" 
                           onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cet enregistrement ?')">Supprimer</a>
                    </div>
                </div>
                
                <div class="voice-detail-section">
                    <h3>üéµ Audio</h3>
                    <audio controls class="audio-player">
                        <source src="{{ voice_entry.audio_file.url }}" type="audio/wav">
                        Votre navigateur ne supporte pas la lecture audio.
                    </audio>
                </div>
                
                <div class="voice-detail-section">
                    <h3>üìù Transcription</h3>
                    <div class="voice-detail-content">
                        {{ voice_entry.transcription }}
                    </div>
                </div>
                
                <div class="voice-detail-section">
                    <h3>üòä Analyse du sentiment</h3>
                    <div class="voice-detail-content">
                        <span class="analysis-badge sentiment-{{ voice_entry.text_sentiment|lower }}">
                            {{ voice_entry.text_sentiment }}
                        </span>
                        <div class="score-detail">
                            Score de confiance: {{ voice_entry.text_sentiment_score|floatformat:3 }}
                        </div>
                    </div>
                </div>
                
                <div class="voice-detail-section">
                    <h3>üéµ D√©tection d'√©motion audio</h3>
                    <div class="voice-detail-content">
                        <span class="analysis-badge emotion-badge">
                            {{ voice_entry.audio_emotion }}
                        </span>
                        <div class="score-detail">
                            Score de confiance: {{ voice_entry.audio_emotion_score|floatformat:3 }}
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    {% include 'partials/footer.html' %}
    <script>
    (function(){
        function getCSRF(){
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || (document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '');
        }
        const editBtn = document.getElementById('editTitleBtn');
        const saveBtn = document.getElementById('saveTitleBtn');
        const cancelBtn = document.getElementById('cancelTitleBtn');
        const input = document.getElementById('titleInput');
        const editor = document.getElementById('titleEditor');
        const display = document.getElementById('titleDisplay');

        function openEditor(){ editor.style.display = 'block'; editBtn.style.display = 'none'; setTimeout(()=>{ try{ input.focus(); input.select(); }catch{} }, 50); }
        function closeEditor(){ editor.style.display = 'none'; editBtn.style.display = 'inline-block'; }

        if (editBtn) editBtn.addEventListener('click', openEditor);
        if (cancelBtn) cancelBtn.addEventListener('click', ()=>{ closeEditor(); });
        if (input) input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveBtn.click(); }});
        if (saveBtn) {
            saveBtn.addEventListener('click', async ()=>{
                const title = (input.value || '').trim();
                saveBtn.textContent = 'Sauvegarde‚Ä¶';
                saveBtn.disabled = true;
                try {
                    const res = await fetch('/voice-journal/api/{{ voice_entry.pk }}/update-title/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCSRF() },
                        body: new URLSearchParams({ title })
                    });
                    const data = await res.json();
                    if (data.success) {
                        input.value = data.title || '';
                        display.textContent = data.title && data.title.length ? data.title : 'Sans titre';
                        closeEditor();
                    } else {
                        alert(data.error || 'Erreur de sauvegarde');
                    }
                } catch { alert('Erreur r√©seau'); }
                finally { saveBtn.textContent = 'Enregistrer'; saveBtn.disabled = false; }
            });
        }
    })();
    </script>
</body>
</html>
