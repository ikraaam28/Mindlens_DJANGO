{% load static %}

<header class="navbar">
  <div class="container nav-inner">
    <a class="brand" href="/">
      <img src="{% static 'css/images/Gemini_Generated_Image_9zqbuv9zqbuv9zqb-removebg-preview2.png' %}" alt="MindLense" />
    </a>
    <nav class="nav-links">
      <a href="/">Accueil</a>

      {% if request.user.is_authenticated %}
        <a href="{% url 'note_list' %}">Mes Notes</a>
        <a href="{% url 'dashboard' %}">Dashboard</a>
        <a href="{% url 'voice_journal' %}">Voix</a>
        <a href="{% url 'voice_journal_list' %}">Mes Voix</a>
        <a href="{% url 'profile' %}">Mon Profil</a>
      {% else %}
        <a href="#notes">Notes</a>
        <a href="#voice">Voix</a>
      {% endif %}

      <a href="{% url 'photo_album_list' %}">Photos</a>
      <a href="{% url 'resume_list' %}">Résumés</a>
      {% if request.user.is_authenticated %}
      {% endif %}
    </nav>

    {% if request.user.is_authenticated %}
      <!-- Notification Icon -->
      <div id="reminder-bell-container" style="position:relative;display:inline-block;margin-left:1rem;vertical-align:middle;cursor:pointer;">
        <!-- SVG Icône Notification -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="color:#4a5568;">
          <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2.965 7H15.97C13.505 12.098 13 7.098 13 6a5.002 5.002 0 0 0-3.005-4.901z"/>
        </svg>

        <!-- Badge -->
        <span id="reminder-badge" style="position:absolute;top:-8px;right:-8px;background:#e53e3e;color:white;font-size:0.65rem;font-weight:bold;min-width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;opacity:0;">
          0
        </span>

        <!-- Dropdown -->
        <div id="reminder-dropdown" style="display:none;position:absolute;right:0;top:100%;background:white;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 8px 16px rgba(0,0,0,0.1);min-width:300px;z-index:1000;margin-top:0.5rem;">
          <div id="reminder-list" style="max-height:400px;overflow-y:auto;">
            <!-- Chargé via JS -->
          </div>
        </div>
      </div>

      <!-- Script AJAX pour charger les rappels -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const badge = document.getElementById('reminder-badge');
          const list = document.getElementById('reminder-list');
          const dropdown = document.getElementById('reminder-dropdown');
          const bell = document.getElementById('reminder-bell-container');

          fetch('{% url "api_unread_reminders" %}')
            .then(response => response.json())
            .then(data => {
              if (data.count > 0) {
                badge.textContent = data.count;
                badge.style.opacity = '1';

                data.reminders.forEach(r => {
                  const priorityColor = 
                    r.priority === 'haute' ? '#e53e3e' : 
                    r.priority === 'moyenne' ? '#dd6b20' : '#718096';
                  const item = `
                    <a href="${r.url}" style="display:block;padding:0.75rem 1rem;border-bottom:1px solid #edf2f7;color:#2d3748;text-decoration:none;font-size:0.9rem;">
                      <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                          <span style="display:inline-block;background:${priorityColor};color:white;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:bold;margin-right:0.5rem;">
                            ${r.priority.charAt(0).toUpperCase() + r.priority.slice(1)}
                          </span>
                          <span style="font-weight:500;">${r.message}</span>
                        </div>
                        <small style="color:#718096;font-size:0.75rem;">${r.time}</small>
                      </div>
                    </a>
                  `;
                  list.innerHTML += item;
                });
              } else {
                list.innerHTML = '<div style="padding:0.75rem 1rem;color:#a0aec0;font-size:0.85rem;text-align:center;">Aucun rappel</div>';
              }

              // Hover
              bell.addEventListener('mouseenter', () => dropdown.style.display = 'block');
              bell.addEventListener('mouseleave', () => dropdown.style.display = 'none');
            })
            .catch(err => {
              console.error("Erreur:", err);
              list.innerHTML = '<div style="padding:0.75rem 1rem;color:#e53e3e;font-size:0.85rem;text-align:center;">Erreur</div>';
            });
        });
      </script>
    {% endif %}

    {% if request.user.is_authenticated %}
      <a class="cta" href="{% url 'logout' %}">Se déconnecter</a>
    {% else %}
      <a class="cta" href="{% url 'login' %}">Se connecter</a>
    {% endif %}
  </div>
</header>